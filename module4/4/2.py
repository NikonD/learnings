import numpy as np
import joblib
import matplotlib.pyplot as plt
from sklearn.semi_supervised import LabelSpreading

# =====================================================
# 1. Генерация данных (сегментация клиентов)
# =====================================================

# Фиксируем seed для воспроизводимости
np.random.seed(42)

# Создаём три естественные группы клиентов:
# group1 — низкий чек, часто приходят
# group2 — высокий чек, редко приходят (VIP-подобные)
# group3 — средний чек и частота

group1 = np.random.normal([5000, 20], [500, 3], size=(100, 2))
group2 = np.random.normal([15000, 5], [1500, 1], size=(100, 2))
group3 = np.random.normal([8000, 12], [800, 2], size=(100, 2))

# Объединяем все группы в один массив
# X имеет форму (300, 2)
# 300 клиентов, 2 признака:
# [средний чек, посещений в месяц]
X = np.vstack([group1, group2, group3])

# =====================================================
# 2. Частичная разметка
# =====================================================

# Создаём массив меток.
# -1 означает: метка неизвестна
labels = np.full(len(X), -1)

# Размечаем только небольшое количество клиентов.
# Это имитация реальной ситуации:
# разметка дорогая, эксперты размечают немного.

labels[110:120] = 1  # считаем их VIP
labels[0:10] = 0     # считаем их обычными

# Остальные 280 клиентов — без метки.

# =====================================================
# 3. Обучение semi-supervised модели
# =====================================================

# Создаём модель LabelSpreading.
# kernel='rbf' означает, что близость точек считается
# через гауссову функцию расстояния.
# gamma регулирует "радиус влияния" точек.
model = LabelSpreading(kernel='rbf', gamma=0.0000001)

# Обучение:
# алгоритм:
# 1. Строит граф похожести между точками
# 2. Распространяет известные метки по графу
# 3. Находит устойчивое распределение классов
model.fit(X, labels)

print("Модель обучена.")

# =====================================================
# 4. Сохранение модели
# =====================================================

# В semi-supervised модели параметры сложные:
# внутри хранится граф, матрицы весов и вероятности.
# Поэтому сохраняем всю модель целиком через joblib.
joblib.dump(model, "semi_supervised_model.pkl")
print("Модель сохранена в semi_supervised_model.pkl")

# =====================================================
# 5. Загрузка модели
# =====================================================

# Загружаем сохранённую модель
loaded_model = joblib.load("semi_supervised_model.pkl")
print("Модель загружена.")

# =====================================================
# 6. Предсказание для нового клиента
# =====================================================

print("\nВведите данные нового клиента:")

# Пользователь вводит признаки
spend = float(input("Средний чек: "))
visits = float(input("Посещений в месяц: "))

# Формируем точку в формате (1, 2)
# sklearn ожидает 2D-массив
new_client = np.array([[spend, visits]])

# predict возвращает наиболее вероятный класс
prediction = loaded_model.predict(new_client)[0]

# predict_proba возвращает вероятности всех классов
probabilities = loaded_model.predict_proba(new_client)[0]

print("\nПредсказанный класс:", prediction)
print("Вероятности классов:", probabilities)

# =====================================================
# 7. Визуализация
# =====================================================

# Предсказываем классы для всех клиентов
# Это итог после распространения меток
predicted_all = loaded_model.predict(X)

plt.figure(figsize=(8, 6))

# -----------------------------------------------------
# 1️⃣ Все клиенты
# -----------------------------------------------------
# Цвет каждой точки соответствует классу,
# который модель определила после обучения.
plt.scatter(
    X[:, 0],              # средний чек
    X[:, 1],              # посещений в месяц
    c=predicted_all,      # цвет = класс
    alpha=0.5,
    label="Клиенты"
)

# -----------------------------------------------------
# 2️⃣ Изначально размеченные точки
# -----------------------------------------------------
# Мы хотим показать студентам,
# какие точки были размечены вручную.
# labels != -1 означает: метка была известна.

labeled_mask = labels != -1

plt.scatter(
    X[labeled_mask, 0],
    X[labeled_mask, 1],
    facecolors="none",     # без заливки
    edgecolors="black",    # чёрная обводка
    s=120,
    linewidths=2,
    label="Изначально размеченные"
)

# -----------------------------------------------------
# Новый клиент
# -----------------------------------------------------
# Отображаем точку, которую ввёл пользователь.
# Делаем её крупной и заметной.

plt.scatter(
    new_client[0, 0],
    new_client[0, 1],
    c="red",
    marker="*",            # звезда
    s=300,
    label="Новый клиент"
)

# Подписываем координаты осей
plt.xlabel("Средний чек")
plt.ylabel("Посещений в месяц")

# Заголовок графика
plt.title("Semi-supervised классификация клиентов")

# Добавляем легенду
plt.legend()

plt.show()