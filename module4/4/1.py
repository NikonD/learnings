import numpy as np
import json
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans

# =====================================================
# 1. Генерация данных
# =====================================================

# Фиксируем random seed, чтобы при каждом запуске
# данные были одинаковыми (воспроизводимость эксперимента)
np.random.seed(42)

# Создаём три разных типа клиентов:
# group1 — низкий чек, частые покупки
# group2 — высокий чек, редкие покупки
# group3 — средний чек, средняя частота

# np.random.normal([mean_x, mean_y], [std_x, std_y], size=(кол-во, 2))
# генерирует точки вокруг заданного центра

group1 = np.random.normal([5000, 20], [500, 3], size=(100, 2))
group2 = np.random.normal([15000, 5], [1500, 1], size=(100, 2))
group3 = np.random.normal([8000, 12], [800, 2], size=(100, 2))

# Объединяем все группы в один массив данных
X = np.vstack([group1, group2, group3])

# Теперь X — это массив формы (300, 2)
# 300 клиентов, 2 признака:
# [средний чек, посещений в месяц]

# =====================================================
# 2. Обучение модели
# =====================================================

# Создаём модель KMeans
# n_clusters=3 — мы предполагаем, что есть 3 сегмента
kmeans = KMeans(n_clusters=3)

# Обучаем модель:
# алгоритм ищет 3 центроида,
# минимизируя внутрикластерную дисперсию
kmeans.fit(X)

# Центроиды — это "представители" каждого кластера
centroids = kmeans.cluster_centers_

print("Центроиды:")
print(centroids)

# =====================================================
# 3. Сохранение модели
# =====================================================

# В KMeans модель = это центроиды
# Больше ничего не нужно для предсказания

model_data = {
    "centroids": centroids.tolist()  # переводим numpy в обычный список
}

# Сохраняем в JSON
with open("kmeans_model.json", "w") as f:
    json.dump(model_data, f)

print("Модель сохранена в kmeans_model.json")

# =====================================================
# 4. Загрузка модели
# =====================================================

# Загружаем центроиды из файла
with open("kmeans_model.json", "r") as f:
    loaded = json.load(f)

# Преобразуем обратно в numpy
loaded_centroids = np.array(loaded["centroids"])

# =====================================================
# 5. Функция предсказания
# =====================================================

def predict(x):
    """
    Предсказание кластера для новой точки.
    Мы считаем расстояние до каждого центроида
    и выбираем ближайший.
    """
    distances = np.linalg.norm(loaded_centroids - x, axis=1)
    return np.argmin(distances)

# =====================================================
# 6. Ввод нового клиента
# =====================================================

print("\nВведите данные нового клиента:")

# Пользователь вводит реальные признаки
spend = float(input("Средний чек: "))
visits = float(input("Посещений в месяц: "))

# Формируем точку
new_client = np.array([spend, visits])

# Определяем, к какому кластеру он относится
cluster_id = predict(new_client)

print("\nНовый клиент отнесён к кластеру:", cluster_id)

# =====================================================
# 7. Визуализация
# =====================================================

# Получаем кластеры всех клиентов
# (это результат работы алгоритма)
all_labels = kmeans.labels_

plt.figure(figsize=(8,6))

# Отображаем всех клиентов
# Цвет = номер кластера
plt.scatter(X[:, 0], X[:, 1], c=all_labels, alpha=0.5)

# Отображаем центроиды
plt.scatter(
    loaded_centroids[:, 0],
    loaded_centroids[:, 1],
    c="red",
    marker="X",
    s=200,
    label="Центроиды"
)

# Отображаем нового клиента
plt.scatter(
    new_client[0],
    new_client[1],
    c="black",
    marker="*",
    s=300,
    label="Новый клиент"
)

plt.xlabel("Средний чек")
plt.ylabel("Посещений в месяц")
plt.title("KMeans сегментация клиентов")
plt.legend()
plt.show()